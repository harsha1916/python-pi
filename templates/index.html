<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Service Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card {
            transition: all 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .image-gallery {
            max-height: 400px;
            overflow-y: auto;
        }
        .image-thumbnail {
            width: 100px;
            height: 75px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
        }
        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .queue-item {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-camera"></i> Camera Service Dashboard
            </span>
            <span class="navbar-text">
                <span id="connection-status" class="status-indicator status-offline"></span>
                <span id="connection-text">Checking...</span>
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <i class="fas fa-images fa-2x text-primary mb-2"></i>
                        <h5 class="card-title">Local Images</h5>
                        <h3 class="text-primary" id="local-count">0</h3>
                        <small class="text-muted">Max: 50</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <i class="fas fa-cloud-upload-alt fa-2x text-warning mb-2"></i>
                        <h5 class="card-title">Upload Queue</h5>
                        <h3 class="text-warning" id="queue-count">0</h3>
                        <small class="text-muted">Pending</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h5 class="card-title">Successful</h5>
                        <h3 class="text-success" id="success-count">0</h3>
                        <small class="text-muted">Uploads</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                        <h5 class="card-title">Failed</h5>
                        <h3 class="text-danger" id="failed-count">0</h3>
                        <small class="text-muted">Uploads</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Configuration Panel -->
            <div class="col-md-4">
                <div class="config-section">
                    <h4><i class="fas fa-cog"></i> Configuration</h4>
                    
                    <div class="mb-3">
                        <label class="form-label">Camera 1 RTSP URL</label>
                        <input type="text" class="form-control" id="camera1-url" placeholder="rtsp://...">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Camera 2 RTSP URL</label>
                        <input type="text" class="form-control" id="camera2-url" placeholder="rtsp://...">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">S3 Upload URL</label>
                        <input type="text" class="form-control" id="s3-url" placeholder="https://...">
                    </div>
                    
                    <button class="btn btn-primary" onclick="updateConfig()">
                        <i class="fas fa-save"></i> Save Configuration
                    </button>
                </div>

                <!-- Camera Controls -->
                <div class="config-section">
                    <h4><i class="fas fa-camera"></i> Camera Controls</h4>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="captureImage('camera_1')">
                            <i class="fas fa-camera"></i> Capture Camera 1
                        </button>
                        <button class="btn btn-success" onclick="captureImage('camera_2')">
                            <i class="fas fa-camera"></i> Capture Camera 2
                        </button>
                    </div>
                    
                    <!-- GPIO Controls -->
                    <div class="mt-3">
                        <h6><i class="fas fa-microchip"></i> GPIO Triggers</h6>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Camera 1 GPIO (Pin 18)</span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="gpio-camera-1" onchange="toggleGPIO('camera_1')">
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Camera 2 GPIO (Pin 19)</span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="gpio-camera-2" onchange="toggleGPIO('camera_2')">
                            </div>
                        </div>
                        <small class="text-muted">Enable GPIO triggers for automatic capture when pins are pulled low</small>
                    </div>
                </div>

                <!-- Upload Controls -->
                <div class="config-section">
                    <h4><i class="fas fa-cloud-upload-alt"></i> Upload Controls</h4>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning" onclick="forceUpload()">
                            <i class="fas fa-upload"></i> Force Upload All
                        </button>
                        <button class="btn btn-info" onclick="scanImages()">
                            <i class="fas fa-search"></i> Scan for Images
                        </button>
                    </div>
                </div>
            </div>

            <!-- Image Gallery -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-images"></i> Image Gallery</h5>
                    </div>
                    <div class="card-body">
                        <div class="image-gallery" id="image-gallery">
                            <!-- Images will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Upload Queue -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> Upload Queue</h5>
                    </div>
                    <div class="card-body">
                        <div id="upload-queue">
                            <!-- Queue items will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalTitle">Image Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" class="img-fluid" alt="Image preview">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let statusInterval;
        let configData = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            loadStatus();
            loadImages();
            loadUploadQueue();
            loadGPIOStatus();
            
            // Update status every 5 seconds
            statusInterval = setInterval(loadStatus, 5000);
        });

        // Load configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                configData = await response.json();
                
                document.getElementById('camera1-url').value = configData.rtsp_cameras.camera_1 || '';
                document.getElementById('camera2-url').value = configData.rtsp_cameras.camera_2 || '';
                document.getElementById('s3-url').value = configData.s3_url || '';
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Update configuration
        async function updateConfig() {
            try {
                const config = {
                    rtsp_cameras: {
                        camera_1: document.getElementById('camera1-url').value,
                        camera_2: document.getElementById('camera2-url').value
                    },
                    s3_url: document.getElementById('s3-url').value
                };

                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                if (result.success) {
                    alert('Configuration updated successfully!');
                } else {
                    alert('Error updating configuration: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating config:', error);
                alert('Error updating configuration');
            }
        }

        // Load system status
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update status cards
                document.getElementById('local-count').textContent = data.local_images;
                document.getElementById('queue-count').textContent = data.queued_uploads;
                document.getElementById('success-count').textContent = data.successful_uploads;
                document.getElementById('failed-count').textContent = data.status.failed_uploads;
                
                // Update connection status
                const statusIndicator = document.getElementById('connection-status');
                const statusText = document.getElementById('connection-text');
                
                if (data.status.online) {
                    statusIndicator.className = 'status-indicator status-online';
                    statusText.textContent = 'Online';
                } else {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusText.textContent = 'Offline';
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Load images
        async function loadImages() {
            try {
                const response = await fetch('/api/images');
                const data = await response.json();
                
                const gallery = document.getElementById('image-gallery');
                gallery.innerHTML = '';
                
                if (data.images.length === 0) {
                    gallery.innerHTML = '<p class="text-muted">No images captured yet.</p>';
                    return;
                }
                
                data.images.forEach(image => {
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'd-inline-block me-2 mb-2';
                    
                    // Format file size
                    const fileSizeKB = (image.size / 1024).toFixed(1);
                    
                    // Format timestamp
                    const createdDate = new Date(image.created);
                    const timeString = createdDate.toLocaleString();
                    
                    // Determine upload status badge
                    const statusBadge = image.upload_status === 'uploaded' 
                        ? '<span class="badge bg-success position-absolute top-0 end-0 m-1"><i class="fas fa-check"></i></span>'
                        : '<span class="badge bg-warning position-absolute top-0 end-0 m-1"><i class="fas fa-clock"></i></span>';
                    
                    imageDiv.innerHTML = `
                        <div class="card position-relative" style="width: 120px;">
                            ${statusBadge}
                            <img src="/api/images/${image.filename}" 
                                 class="card-img-top image-thumbnail" 
                                 onclick="showImageModal('${image.filename}')"
                                 title="${image.filename}"
                                 style="height: 80px; object-fit: cover;">
                            <div class="card-body p-1">
                                <div class="small text-muted">
                                    <div><strong>${timeString}</strong></div>
                                    <div>${fileSizeKB} KB</div>
                                    <div class="mt-1">
                                        <span class="badge ${image.upload_status === 'uploaded' ? 'bg-success' : 'bg-warning'} badge-sm">
                                            ${image.upload_status === 'uploaded' ? 'Uploaded' : 'Pending'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    gallery.appendChild(imageDiv);
                });
            } catch (error) {
                console.error('Error loading images:', error);
            }
        }

        // Load upload queue
        async function loadUploadQueue() {
            try {
                const response = await fetch('/api/upload-queue');
                const data = await response.json();
                
                const queueDiv = document.getElementById('upload-queue');
                queueDiv.innerHTML = '';
                
                if (data.queue.length === 0) {
                    queueDiv.innerHTML = '<p class="text-muted">No items in upload queue.</p>';
                    return;
                }
                
                data.queue.forEach(item => {
                    const queueItem = document.createElement('div');
                    queueItem.className = 'queue-item';
                    
                    // Format timestamp
                    const createdDate = new Date(item.created);
                    const timeString = createdDate.toLocaleString();
                    const fileSizeKB = (item.size / 1024).toFixed(1);
                    
                    queueItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${item.filename}</strong>
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> ${timeString}<br>
                                    <i class="fas fa-file"></i> ${fileSizeKB} KB
                                </small>
                            </div>
                            <span class="badge bg-warning">
                                <i class="fas fa-upload"></i> Pending
                            </span>
                        </div>
                    `;
                    queueDiv.appendChild(queueItem);
                });
            } catch (error) {
                console.error('Error loading upload queue:', error);
            }
        }

        // Capture image
        async function captureImage(cameraId) {
            try {
                const response = await fetch(`/api/capture/${cameraId}`);
                const result = await response.json();
                
                if (result.success) {
                    alert(`Image captured successfully from ${cameraId}!`);
                    loadImages();
                    loadStatus();
                } else {
                    alert(`Error capturing image: ${result.message}`);
                }
            } catch (error) {
                console.error('Error capturing image:', error);
                alert('Error capturing image');
            }
        }

        // Force upload
        async function forceUpload() {
            try {
                const response = await fetch('/api/force-upload', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(`Upload completed! Uploaded: ${result.uploaded}, Failed: ${result.failed}, Remaining: ${result.remaining}`);
                    loadUploadQueue();
                    loadStatus();
                } else {
                    alert(`Upload failed: ${result.message}`);
                }
            } catch (error) {
                console.error('Error forcing upload:', error);
                alert('Error forcing upload');
            }
        }

        // Show image modal
        function showImageModal(filename) {
            document.getElementById('imageModalTitle').textContent = filename;
            document.getElementById('modalImage').src = `/api/images/${filename}`;
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }

        // Scan for existing images
        async function scanImages() {
            try {
                const response = await fetch('/api/scan-images', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(`Scan completed! Found ${result.count} images.`);
                    loadImages();
                    loadStatus();
                } else {
                    alert(`Scan failed: ${result.message}`);
                }
            } catch (error) {
                console.error('Error scanning images:', error);
                alert('Error scanning images');
            }
        }

        // Toggle GPIO for camera
        async function toggleGPIO(cameraId) {
            try {
                const enabled = document.getElementById(`gpio-camera-${cameraId.split('_')[1]}`).checked;
                const response = await fetch('/api/gpio-toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        camera_id: cameraId,
                        enabled: enabled
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const status = enabled ? 'enabled' : 'disabled';
                    console.log(`GPIO trigger ${status} for ${cameraId}`);
                } else {
                    alert(`Failed to toggle GPIO: ${result.message}`);
                    // Revert the toggle
                    document.getElementById(`gpio-camera-${cameraId.split('_')[1]}`).checked = !enabled;
                }
            } catch (error) {
                console.error('Error toggling GPIO:', error);
                alert('Error toggling GPIO');
                // Revert the toggle
                const checkbox = document.getElementById(`gpio-camera-${cameraId.split('_')[1]}`);
                checkbox.checked = !checkbox.checked;
            }
        }

        // Load GPIO status
        async function loadGPIOStatus() {
            try {
                const response = await fetch('/api/gpio-status');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('gpio-camera-1').checked = result.gpio_status.camera_1;
                    document.getElementById('gpio-camera-2').checked = result.gpio_status.camera_2;
                }
            } catch (error) {
                console.error('Error loading GPIO status:', error);
            }
        }

        // Refresh data periodically
        setInterval(() => {
            loadImages();
            loadUploadQueue();
        }, 10000); // Refresh every 10 seconds
    </script>
</body>
</html>
